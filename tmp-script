#!/bin/sh

# ================= KONFIGURATION =================
# Hier den Namen deines lokalen Datastores eintragen!
# Beispiel: /vmfs/volumes/datastore1/VMs
SOURCE_PARENT="/vmfs/volumes/DEIN_LOKALER_DATASTORE/VMs"

# Ziel auf dem USB-Stick
TARGET_PARENT="/vmfs/volumes/USB_TRANSFER/VM_Backups"
# =================================================

# Sicherstellen, dass der USB-Stick gemountet ist
if [ ! -d "$TARGET_PARENT" ]; then
    mkdir -p "$TARGET_PARENT"
fi

# Schleife durch alle Ordner im VMs-Verzeichnis
for VM_PATH in "$SOURCE_PARENT"/*; do
    if [ -d "$VM_PATH" ]; then
        # Ordnernamen herausfinden (z.B. "Webserver")
        VM_NAME=$(basename "$VM_PATH")
        
        echo "========================================"
        echo "Verarbeite VM: $VM_NAME"
        
        # Zielordner auf USB erstellen
        TARGET_DIR="$TARGET_PARENT/$VM_NAME"
        mkdir -p "$TARGET_DIR"
        
        # 1. Kleine Config-Dateien kopieren (schnell)
        echo "-> Kopiere Configs..."
        cp "$VM_PATH/"*.vmx "$TARGET_DIR/" 2>/dev/null
        cp "$VM_PATH/"*.nvram "$TARGET_DIR/" 2>/dev/null
        cp "$VM_PATH/"*.vmsd "$TARGET_DIR/" 2>/dev/null
        
        # 2. Festplatten klonen (Thin Provisioning!)
        # Findet alle vmdks, ignoriert aber die -flat Dateien
        echo "-> Klone Festplatten (Thin)..."
        for DISK in $(ls "$VM_PATH/"*.vmdk 2>/dev/null | grep -v -- "-flat.vmdk" | grep -v -- "-sesparse.vmdk" | grep -v -- "-digest.vmdk"); do
            DISK_FILENAME=$(basename "$DISK")
            echo "   ... $DISK_FILENAME"
            vmkfstools -i "$DISK" -d thin "$TARGET_DIR/$DISK_FILENAME"
        done
        
        echo "-> Fertig mit $VM_NAME"
    fi
done

echo "========================================"
echo "Alle VMs aus dem Ordner Ã¼bertragen."
