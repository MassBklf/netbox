#!/bin/sh

# ================= KONFIGURATION =================
# QUELLE: Der Ordner auf dem USB-Stick
SOURCE_PARENT="/vmfs/volumes/USB_TRANSFER/VM_Backups"

# ZIEL: Dein lokaler Datastore auf dem neuen Server (ANPASSEN!!!)
# Beispiel: /vmfs/volumes/datastore1
TARGET_DATASTORE="/vmfs/volumes/datastore1"
# =================================================

echo "Starte Restore von USB nach $TARGET_DATASTORE..."

# Schleife durch alle VM-Backups auf dem USB-Stick
for VM_PATH in "$SOURCE_PARENT"/*; do
    if [ -d "$VM_PATH" ]; then
        VM_NAME=$(basename "$VM_PATH")
        TARGET_DIR="$TARGET_DATASTORE/$VM_NAME"
        
        echo "----------------------------------------"
        echo "Wiederherstellung von: $VM_NAME"
        
        # Zielordner erstellen
        mkdir -p "$TARGET_DIR"
        
        # 1. Kleine Config-Dateien kopieren
        echo "-> Kopiere Configs..."
        cp "$VM_PATH/"*.vmx "$TARGET_DIR/" 2>/dev/null
        cp "$VM_PATH/"*.nvram "$TARGET_DIR/" 2>/dev/null
        cp "$VM_PATH/"*.vmsd "$TARGET_DIR/" 2>/dev/null
        
        # 2. Festplatten importieren
        # Wir nutzen vmkfstools fÃ¼r sauberen Import
        echo "-> Importiere Disks..."
        for DISK in $(ls "$VM_PATH/"*.vmdk 2>/dev/null | grep -v -- "-flat.vmdk" | grep -v -- "-sesparse.vmdk"); do
            DISK_FILENAME=$(basename "$DISK")
            echo "   ... $DISK_FILENAME"
            vmkfstools -i "$DISK" -d thin "$TARGET_DIR/$DISK_FILENAME"
        done
        
        # 3. VM im ESXi registrieren (Der magische Schritt!)
        # Damit taucht sie sofort in der GUI auf
        VMX_FILE="$TARGET_DIR/$VM_NAME.vmx"
        if [ -f "$VMX_FILE" ]; then
            echo "-> Registriere VM im Inventory..."
            vim-cmd solo/registervm "$VMX_FILE"
        fi
        
        echo "-> [OK] $VM_NAME wiederhergestellt."
    fi
done

echo "========================================"
echo "ALLE VMS IMPORTIERT UND REGISTRIERT."
