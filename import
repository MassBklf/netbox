#!/bin/sh

# ================= KONFIGURATION =================
# QUELLE: Der Ordner auf dem USB-Stick
SOURCE_PARENT="/vmfs/volumes/USB_TRANSFER/VM_Backups"

# ZIEL: Dein lokaler Datastore (ANPASSEN!)
TARGET_DATASTORE="/vmfs/volumes/datastore1"
# =================================================

echo "Starte Restore (VMS ÜBERSPRINGEN, FALLS VORHANDEN)..."

# Prüfen ob Quelle existiert
if [ ! -d "$SOURCE_PARENT" ]; then
    echo "FEHLER: Quellordner $SOURCE_PARENT nicht gefunden!"
    exit 1
fi

# Schleife durch alle VM-Backups
for VM_PATH in "$SOURCE_PARENT"/*; do
    if [ -d "$VM_PATH" ]; then
        VM_NAME=$(basename "$VM_PATH")
        TARGET_DIR="$TARGET_DATASTORE/$VM_NAME"
        
        echo "----------------------------------------"
        echo "Prüfe: $VM_NAME"
        
        # --- NEU: SICHERHEITS-CHECK ---
        if [ -d "$TARGET_DIR" ]; then
            echo "ACHTUNG: Ordner existiert bereits ($TARGET_DIR)."
            echo "-> ÜBERSPRINGE diese VM, um Daten nicht zu überschreiben."
            continue
        fi
        # ------------------------------
        
        # Ab hier läuft der normale Restore
        mkdir -p "$TARGET_DIR"
        
        # 1. Configs kopieren
        echo "-> Kopiere Configs..."
        cp "$VM_PATH/"*.vmx "$TARGET_DIR/" 2>/dev/null
        cp "$VM_PATH/"*.nvram "$TARGET_DIR/" 2>/dev/null
        cp "$VM_PATH/"*.vmsd "$TARGET_DIR/" 2>/dev/null
        
        # 2. Disks importieren (Thin)
        echo "-> Importiere Disks..."
        for DISK in $(ls "$VM_PATH/"*.vmdk 2>/dev/null | grep -v -- "-flat.vmdk" | grep -v -- "-sesparse.vmdk"); do
            DISK_FILENAME=$(basename "$DISK")
            echo "   ... $DISK_FILENAME"
            vmkfstools -i "$DISK" -d thin "$TARGET_DIR/$DISK_FILENAME"
        done
        
        # 3. Registrieren
        VMX_FILE="$TARGET_DIR/$VM_NAME.vmx"
        if [ -f "$VMX_FILE" ]; then
            echo "-> Registriere VM..."
            vim-cmd solo/registervm "$VMX_FILE"
        fi
        
        echo "-> [OK] $VM_NAME wiederhergestellt."
    fi
done

echo "========================================"
echo "FERTIG."
